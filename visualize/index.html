<!-- Resources -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script src="https://www.amcharts.com/lib/3/amcharts.js"></script>
<script src="https://www.amcharts.com/lib/3/serial.js"></script>
<script src="https://www.amcharts.com/lib/3/plugins/export/export.min.js"></script>
<link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />
<script src="https://www.amcharts.com/lib/3/themes/light.js"></script>


<script src="/socket.io/socket.io.js"></script>

<div id='container' style="height:500px;width:100%;font-size: 11px"></div>
<!-- Chart code -->
<script type="text/javascript">
//var chart_data = [ { "country_code": "USA", "count": 10 }, 
//                   { "country_code": "China", "count": 10} 
//                 ];
var chart_data = [];
var addNewElement = function(arr, newElement) {
	

    var found = false;
    for(var i=0; element=arr[i]; i++) {
        if(element.country_code == newElement.country_code) {
            found = true;
            if(newElement.count === 0) {
                arr[i] = false;
            } else {
                arr[i] = newElement;
            }            
        }
    }
    if(found === false) {
        arr.push(newElement);
    }
    // removing elements
    var newArr = [];
    for(var i=0; element=arr[i]; i++) {
        if(element !== false) newArr.push(element);
    }
    return newArr;
}
    $(document).ready(function () {
	    var socket = io();

chart = AmCharts.makeChart( "container", {
  "type": "serial",
  "theme": "light",
  "dataProvider": chart_data,
"valueAxes": [{
    "axisAlpha": 0,
    "position": "left",
    "minimum": 0,
    "title": "Bike Rentals per country"
  }],
  "startDuration": 0.5,
  "graphs": [{
    "balloonText": "<b>[[category]]: [[value]]</b>",
    "fillColorsField": "color",
    "fillAlphas": 0.9,
    "lineAlpha": 0.2,
    "type": "column",
    "valueField": "count"
  }],
  "chartCursor": {
    "categoryBalloonEnabled": false,
    "cursorAlpha": 0,
    "zoomable": false
  },
  "categoryField": "country_code",
  "categoryAxis": {
    "gridPosition": "start",
    "labelRotation": 45
  },
  "export": {
    "enabled": true
  }
} );
        socket.on('message', function(data){
          console.log(data)
           data = JSON.parse(data);
            chart_data = addNewElement(chart_data, data);
            chart.dataProvider = chart_data;
            chart.validateData();
            //chart.series[0].addPoint(data, true, true);
//            var foo = {
//            name: 'FOO',
//            lat: 51.507222,
//            lon: -0.1275
//            };
//        console.log(chart.series[2].data);
//        chart.series[2].addPoint(foo);
//        console.log(chart.series[2].data);
        //chart.redraw();
    //chart.series[2].addPoint(data);
        //chart.series[0].addPoint((new Date()).getTime(), foo], true, true);
        //chart.series.setData(foo,true);
 //       chart.series[0].addPoint([foo],true);
 //           chart.redraw();
        });
   });
</script>

<!-- HTML -->
<div id="chartdiv"></div>